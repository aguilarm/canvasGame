function AngleBetween(a,b){var c=a.dot(b),d=a.length()*b.length(),e=c/d;return Math.acos(e)}function drawSprite(a,b,c){for(d in gSpriteSheets){var d=gSpriteSheets.master,e=d.getStats(a);if(null!=e)return void __drawSpriteInternal(e,d,b,c)}}function __drawSpriteInternal(a,b,c,d,e){if(null!=a&&null!=b){var f=gGameEngine.gMap,g={x:a.cx,y:a.cy},h={x:f.viewRect.x,y:f.viewRect.y},i=gRenderEngine.context;if(e&&(e.noMapTrans&&(h.x=0,h.y=0),e.ctx&&(i=e.ctx)),e&&null!=e.rotRadians){i.save();var j=Math.PI+e.rotRadians;i.translate(c-h.x,d-h.y),i.rotate(j),i.drawImage(b.img,a.x,a.y,a.w,a.h,+g.x,+g.y,a.w,a.h),i.restore()}else i.drawImage(b.img,a.x,a.y,a.w,a.h,c-h.x+g.x,d-h.y+g.y,a.w,a.h)}}ClientGameEngineClass=GameEngineClass.extend({gSocket:null,newMapPos:{x:0,y:0},init:function(){this.parent()},setup:function(){this.parent(),gInputEngine.bind(gInputEngine.KEY.W,"move-up"),gInputEngine.bind(gInputEngine.KEY.S,"move-down"),gInputEngine.bind(gInputEngine.KEY.A,"move-left"),gInputEngine.bind(gInputEngine.KEY.D,"move-right"),gInputEngine.bind(gInputEngine.KEY.SHIFT,"run")},update:function(){this.parent();if(gRenderEngine.canvas.width!=this.gMap.viewRect.w&&(this.gMap.viewRect.w=gRenderEngine.canvas.width),gRenderEngine.canvas.height!=this.gMap.viewRect.h&&(this.gMap.viewRect.h=gRenderEngine.canvas.height),this.gPlayer0&&!this.gPlayer0.isDead){var a={x:0,y:0,faceAngle0to7:0,walking:!1},b=new Vec2(0,0);if(gInputEngine.state("move-up")&&(b.y-=1),gInputEngine.state("move-down")&&(b.y+=1),gInputEngine.state("move-left")&&(b.x-=1),gInputEngine.state("move-right")&&(b.x+=1),b.LengthSquared()){if(a.walking=!0,b.Normalize(),!gInputEngine.state("run")&&(b.Multiply(this.gPlayer0.walkSpeed),.2!=this.gPlayer0._walkSpriteAnimList[0]._animIncPerFrame))for(i=0;4>i;i++)this.gPlayer0._walkSpriteAnimList[i]._animIncPerFrame=.2;if(gInputEngine.state("run"))for(b.Multiply(2*this.gPlayer0.walkSpeed),i=0;4>i;i++)this.gPlayer0._walkSpriteAnimList[i]._animIncPerFrame=.4;a.x+=b.x,a.y+=b.y}else a.walking=!1,a.x=0,a.y=0;var c=(this.gPlayer0.pos.x,this.gPlayer0.pos.y,this.gPlayer0.faceAngleRadians);a.faceAngle0to7=(Math.round(c/(2*Math.PI)*8)+8)%8,this.gPlayer0.pInput=a,this.gPlayer0.sendUpdates(),this.gPlayer0.applyInputs(),this.newMapPos.x=this.gPlayer0.pos.x-.5*this.gMap.viewRect.w,this.newMapPos.y=this.gPlayer0.pos.y-.5*this.gMap.viewRect.h}},run:function(){this.parent();var a=this.timeSincePhysicsUpdate/Constants.PHYSICS_LOOP_HZ;this.update(),this.draw(a),gInputEngine.clearPressed()},draw:function(a){this.gMap.viewRect.x=parseInt(alphaBeta(this.gMap.viewRect.x,this.newMapPos.x,.9)),this.gMap.viewRect.y=parseInt(alphaBeta(this.gMap.viewRect.y,this.newMapPos.y,.9)),this.gMap.draw(null),this.entities.forEach(function(b){b.draw(a)})},preloadComplete:!1,preloadAssets:function(){var a=new Array;a.push("img/master.png");for(var b=mapOutside,c=0;c<b.tilesets.length;c++)a.push("img/"+b.tilesets[c].image.replace(/^.*[\\\/]/,""));loadAssets(a,function(){xhrGet("img/master.json",!1,function(a){var b=JSON.parse(a.response),c=new SpriteSheetClass;gSpriteSheets.master=c,c.load("img/master.png");for(var d in b.frames){var e=b.frames[d],f=.5*-e.frame.w,g=.5*-e.frame.h;e.trimmed&&(f=e.spriteSourceSize.x-.5*e.sourceSize.w,g=e.spriteSourceSize.y-.5*e.sourceSize.h),c.defSprite(d,e.frame.x,e.frame.y,e.frame.w,e.frame.h,f,g)}gGameEngine.preloadComplete=!0})})}});var gGameEngine=new ClientGameEngineClass;ClientPlayerClass=PlayerClass.extend({_walkSpriteAnimList:[],_legSpriteMaskAnimList:[],_currWalkAnimIndex:0,init:function(a,b,c){this.zIndex=8;for(var d=["walk_down","walk_up"],e=["walk_left","walk_right"],f=0;f<d.length;f++){var g=new SpriteSheetAnimClass;g._animIncPerFrame=.2,g.loadSheet("master","img/master.png");for(var h=1;8>h;h++)g.pushFrame("male_"+d[f]+"_0"+h);this._walkSpriteAnimList.push(g)}for(var f=0;f<e.length;f++){var g=new SpriteSheetAnimClass;g._animIncPerFrame=.2,g.loadSheet("master","img/master.png");for(var h=0;8>h;h++)g.pushFrame("male_"+e[f]+"_0"+h);this._walkSpriteAnimList.push(g)}this.parent(a,b,c)},update:function(){if(this.parent(),!this.isDead){this._walkSpriteAnimList[this._currWalkAnimIndex].pause(!this.walking);{new Vec2(0,0)}gInputEngine.state("move-up")?this._currWalkAnimIndex=1:gInputEngine.state("move-down")&&(this._currWalkAnimIndex=0),gInputEngine.state("move-left")?this._currWalkAnimIndex=2:gInputEngine.state("move-right")&&(this._currWalkAnimIndex=3)}},on_stats:function(a){if(this.parent(a),this.health<=0&&!this.isDead){var b={x:this.pos.x,y:this.pos.y},c=(gRenderEngine.getScreenPosition(b).x,gRenderEngine.getScreenPosition(b).y,gGameEngine.spawnEntity("InstancedEffect",this.pos.x,this.pos.y,null));c.onInit({x:this.pos.x,y:this.pos.y},{playOnce:!0,similarName:"landmine_explosion_large_",uriToSound:"./sound/explode0.ogg"}),this==gGameEngine.gPlayer0&&show_respawn()}},draw:function(a){if(!this.isDead){var b=gRenderEngine.context,c={x:this.pos.x,y:this.pos.y};this.pInput&&(c.x+=this.pInput.x*Constants.PHYSICS_LOOP_HZ*a,c.y+=this.pInput.y*Constants.PHYSICS_LOOP_HZ*a);var d=gRenderEngine.getScreenPosition(c).x,e=gRenderEngine.getScreenPosition(c).y;this._drawPlayerAvatar(b,{player:this,locX:d,locY:e})}},_drawPlayerAvatar:function(a,b){b.player._walkSpriteAnimList[b.player._currWalkAnimIndex].getCurrentFrameStats(),b.locX,b.locY;1==b.player.walking&&(sptidx=b.player.legWalkFrameIdx);b.player._walkSpriteAnimList[b.player._currWalkAnimIndex].draw(this.pos.x,this.pos.y,{ctx:a})}}),Factory.nameClassMap.Player=ClientPlayerClass,InputEngineClass=Class.extend({bindings:{},actions:{},presses:{},locks:{},delayedKeyup:[],mouse:{x:0,y:0},screenMouse:{x:0,y:0},setup:function(){},onMouseMoveEvent:function(a){this.mouse.x=a.clientX,this.mouse.y=a.clientY},onKeyDownEvent:function(a,b){var c=a,d=this.bindings[c];d&&(this.actions[d]=!0,b&&b.cancelable&&b.preventDefault(),this.locks[d]||(this.presses[d]=!0,this.locks[d]=!0))},onKeyUpEvent:function(a,b){var c=a,d=this.bindings[c];d&&(b&&b.cancelable&&b.preventDefault(),this.delayedKeyup.push(d))},bind:function(a,b){this.bindings[a]=b},state:function(a){return this.actions[a]},clearState:function(a){this.actions[a]=!1},pressed:function(a){return this.presses[a]},clearPressed:function(){for(var a=0;a<this.delayedKeyup.length;a++){var b=this.delayedKeyup[a];this.actions[b]=!1,this.locks[b]=!1}this.delayedKeyup=[],this.presses={}},clearAllState:function(){this.actions={},this.locks={},this.delayedKeyup=[],this.presses={}}}),KEY={MOUSE1:-1,MOUSE2:-3,MWHEEL_UP:-4,MWHEEL_DOWN:-5,BACKSPACE:8,TAB:9,ENTER:13,PAUSE:19,CAPS:20,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBSTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,SHIFT:16,CTRL:17,ALT:18,PLUS:187,COMMA:188,MINUS:189,PERIOD:190};var gInputEngine=new InputEngineClass;gInputEngine.KEY=KEY,RenderEngineClass=Class.extend({canvas:null,context:null,lastMouse:{x:0,y:0},lastMouseCanvas:{x:0,y:0},init:function(){},setup:function(){this.canvas=document.getElementById("mainCanvas"),this.context=this.canvas.getContext("2d"),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,window.addEventListener("keydown",this.keydown,!1),window.addEventListener("keyup",this.keyup,!1),window.addEventListener("mousedown",this.mousedown,!1),window.addEventListener("mouseup",this.mouseup,!1),window.addEventListener("mousemove",this.mousemove,!1)},keydown:function(a){"text"!=a.target.type&&gInputEngine.onKeyDownEvent(a.keyCode,a)},keyup:function(a){"text"!=a.target.type&&gInputEngine.onKeyUpEvent(a.keyCode,a)},mousemove:function(a){for(var b=this.canvas,c={left:0,top:0};null!=b;)c.left+=b.offsetLeft,c.top+=b.offsetTop,b=b.offsetParent;var d=a.pageX,e=a.pageY;gRenderEngine.lastMouse.x=d,gRenderEngine.lastMouse.y=e,gInputEngine.onMouseMoveEvent(gRenderEngine.lastMouse.x,gRenderEngine.lastMouse.y),gRenderEngine.lastMouseCanvas.x=gRenderEngine.lastMouse.x,gRenderEngine.lastMouseCanvas.y=gRenderEngine.lastMouse.y-gRenderEngine.canvas.offsetTop},getCanvasPosition:function(a){return{x:a.x-this.canvas.offsetLeft,y:a.y-this.canvas.offsetTop}},getScreenPosition:function(a){return{x:-gGameEngine.gMap.viewRect.x+a.x,y:-gGameEngine.gMap.viewRect.y+a.y}},getWorldPosition:function(a){var b=gGameEngine.gMap;return{x:a.x+b.viewRect.x,y:a.y+b.viewRect.y}}});var gRenderEngine=new RenderEngineClass;ImageCache={},loadAtlasImage=function(a){if(null!=ImageCache[a])return ImageCache[a];var b=new Image;return b.src=a,ImageCache[a]=b,b},SpriteSheetClass=Class.extend({img:null,url:"",sprites:new Array,init:function(){},load:function(a){this.img=loadAtlasImage(a),this.url=a},defSprite:function(a,b,c,d,e,f,g){var h={id:a,x:b,y:c,w:d,h:e,cx:null==f?0:f,cy:null==g?0:g};this.sprites.push(h)},getStats:function(a){for(var b=0;b<this.sprites.length;b++)if(this.sprites[b].id==a)return this.sprites[b];return null}}),SpriteSheetAnimClass=Class.extend({_spriteSheet:null,_spriteNames:new Array,_currAnimIdx:0,_fps:15,_animIncPerFrame:.5,_paused:!1,loadSheet:function(a,b){if(this._spriteSheet=gSpriteSheets[a],null==this._spriteSheet){var c=new SpriteSheetClass;c.load(b),this._spriteSheet=c,gSpriteSheets.master=c,this._spriteNames.length=0,this._currAnimIdx=0}},pushFrame:function(a){this._spriteNames.push(a)},pause:function(a){this._paused=a},getNumFrames:function(){return this._spriteNames.length},draw:function(a,b,c){if(null!=this._spriteSheet){this._paused||(this._currAnimIdx+=this._animIncPerFrame);var d=Math.floor(this._currAnimIdx)%this._spriteNames.length,e=this._spriteSheet.getStats(this._spriteNames[d]);null!=e&&__drawSpriteInternal(e,this._spriteSheet,a,b,c)}},getCurrentFrameStats:function(){var a=Math.floor(this._currAnimIdx)%this._spriteNames.length;return this._spriteSheet.getStats(this._spriteNames[a])}});var gSpriteSheets={};